{% load static %}
<!doctype html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EventMandu | {{ event.title }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v=20260228a" />
  </head>
  <body class="d-flex flex-column min-vh-100">
    <nav class="navbar navbar-expand-lg fixed-top brand-nav navbar-dark">
      <div class="container">
        <a class="navbar-brand brand-name" href="{% url 'home' %}"
          >EventMandu</a
        >
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav mx-auto text-center">
            <li class="nav-item">
              <a
                class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}"
                href="{% url 'home' %}"
                >Home</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link {% if request.resolver_match.url_name == 'events' or request.resolver_match.url_name == 'event_detail' %}active{% endif %}"
                href="{% url 'events' %}"
                >Events</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link {% if request.resolver_match.url_name == 'venues' %}active{% endif %}"
                href="{% url 'venues' %}"
                >Venues</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link {% if request.resolver_match.url_name == 'contact' %}active{% endif %}"
                href="{% url 'contact' %}"
                >Contact</a
              >
            </li>
          </ul>
          <div class="d-flex align-items-center gap-2 justify-content-center">
            <button
              class="btn btn-sm theme-toggle"
              id="themeToggle"
              type="button"
              aria-label="Toggle theme"
            >
              <i class="fa-solid fa-moon"></i>
            </button>
            {% if user.is_authenticated %}
            <div class="dropdown">
              <button
                class="btn btn-sm btn-light dropdown-toggle"
                type="button"
                data-bs-toggle="dropdown"
              >
                <i class="fa-solid fa-user"></i> {{ user.username }}
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a
                    class="dropdown-item"
                    href="{% url 'profile_preferences' %}"
                    >Profile & Preferences</a
                  >
                </li>
                {% if user_role == "admin" %}
                <li>
                  <a class="dropdown-item" href="{% url 'admin_dashboard' %}">Admin Dashboard</a>
                </li>
                {% endif %}
                {% if user_role == "organizer" or user_role == "admin" %}
                <li>
                  <a class="dropdown-item" href="{% url 'organizer_dashboard' %}">Organizer Dashboard</a>
                </li>
                {% endif %}
                <li>
                  <a class="dropdown-item" href="{% url 'tickets' %}"
                    >My Tickets</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="{% url 'logout' %}">Logout</a>
                </li>
              </ul>
            </div>
            {% else %}
            <a class="btn btn-sm btn-light" href="{% url 'login' %}">Login</a>
            <a class="btn btn-sm btn-outline-light" href="{% url 'register' %}"
              >Sign Up</a
            >
            {% endif %}
          </div>
        </div>
      </div>
    </nav>

    <main class="section-space pt-4 flex-grow-1">
      <div class="container">
        {% if messages %}
        <div class="mb-3">
          {% for message in messages %}
          <div class="alert alert-{{ message.tags|default:'info' }} mb-2">
            {{ message }}
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <div class="mb-3">
          <a href="{% url 'events' %}" class="btn btn-outline-brand btn-sm"
            ><i class="fa-solid fa-arrow-left me-2"></i>Back to Events</a
          >
        </div>

        <section class="row g-4 align-items-start">
          <div class="col-lg-7">
            <div class="event-card h-100">
              <h1 class="section-title mb-2">{{ event.title }}</h1>
              <p class="section-subtitle mb-3">{{ event.description }}</p>
              <div class="row g-3">
                <div class="col-sm-6">
                  <p class="event-meta mb-2"><i class="fa-regular fa-calendar me-2"></i>Starts: {{ event.start_date|date:"M d, Y h:i A" }}</p>
                  <p class="event-meta mb-2"><i class="fa-regular fa-clock me-2"></i>Ends: {{ event.end_date|date:"M d, Y h:i A" }}</p>
                  <p class="event-meta mb-2"><i class="fa-solid fa-layer-group me-2"></i>{{ event.category.name|default:"General" }}</p>
                </div>
                <div class="col-sm-6">
                  <p class="event-meta mb-2"><i class="fa-solid fa-location-dot me-2"></i>{{ event.venue.city }} - {{ event.venue.name }}</p>
                  <p class="event-meta mb-2"><i class="fa-solid fa-map-location-dot me-2"></i>{{ event.venue.address }}</p>
                  <p class="event-meta mb-2"><i class="fa-solid fa-users me-2"></i>Capacity: {{ event.venue.capacity }}</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-5">
            <div class="ticket-panel h-100">
              <h5 class="mb-2">Reserve Tickets</h5>
              <p class="event-price mb-3">NPR {{ event.price }}</p>
              {% if user.is_authenticated %}
              <form
                method="post"
                action="{% url 'buy_ticket' event.id %}"
                class="ticket-buy-form"
                data-unit-price="{{ event.price }}"
              >
                {% csrf_token %}
                <div class="mb-3">
                  <label class="filter-label" for="ticket_quantity"
                    >Tickets</label
                  >
                  <select
                    name="ticket_quantity"
                    id="ticket_quantity"
                    class="form-select ticket-qty"
                  >
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="filter-label d-block">Payment Method</label>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="payment_method"
                      id="paymentKhalti"
                      value="khalti"
                      checked
                    />
                    <label class="form-check-label" for="paymentKhalti"
                      >Khalti (e-Payment)</label
                    >
                  </div>
                  <small class="text-muted"
                    >You will be redirected to Khalti to complete payment
                    securely.</small
                  >
                </div>
                <div class="d-flex align-items-center gap-2 mb-3">
                  <span class="small"
                    >Total: NPR
                    <strong class="ticket-total"
                      >{{ event.price }}</strong
                    ></span
                  >
                </div>
                <button type="submit" class="btn btn-accent-brand w-100">
                  Pay with Khalti
                </button>
              </form>
              {% else %}
              <p class="section-subtitle mb-3">
                Login to reserve tickets and proceed to payment.
              </p>
              <a href="{% url 'login' %}" class="btn btn-primary-brand w-100"
                >Login to Continue</a
              >
              {% endif %}
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer class="site-footer">
      <div class="container text-center">
        <h5 class="mb-2">EventMandu</h5>
        <div class="mb-2">
          <a class="footer-link" href="{% url 'home' %}">Home</a>
          <a class="footer-link" href="{% url 'events' %}">Events</a>
          <a class="footer-link" href="{% url 'contact' %}">Contact</a>
        </div>
        <small
          ><i class="fa-regular fa-copyright"></i> 2026 EventMandu. Terms &
          Privacy.</small
        >
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      (function () {
        const root = document.documentElement;
        const toggle = document.getElementById("themeToggle");
        const saved = localStorage.getItem("eventmandu-theme");
        if (saved) {
          root.setAttribute("data-bs-theme", saved);
        }
        if (toggle) {
          toggle.addEventListener("click", function () {
            const current =
              root.getAttribute("data-bs-theme") === "dark" ? "dark" : "light";
            const next = current === "dark" ? "light" : "dark";
            root.setAttribute("data-bs-theme", next);
            localStorage.setItem("eventmandu-theme", next);
          });
        }

        document.querySelectorAll(".ticket-buy-form").forEach(function (form) {
          const select = form.querySelector(".ticket-qty");
          const totalEl = form.querySelector(".ticket-total");
          const unitPrice = parseFloat(form.dataset.unitPrice);

          function updateTotal() {
            const qty = parseInt(select.value || "1", 10);
            const total = (isNaN(unitPrice) ? 0 : unitPrice) * qty;
            totalEl.textContent = total.toFixed(2);
          }

          updateTotal();
          select.addEventListener("change", updateTotal);
        });
      })();
    </script>
  </body>
</html>
