{% load static %}
<!doctype html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Organizer Dashboard | EventMandu</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v=20260228a" />
  </head>
  <body class="d-flex flex-column min-vh-100">
    <nav class="navbar navbar-expand-lg fixed-top brand-nav navbar-dark">
      <div class="container">
        <a class="navbar-brand brand-name" href="{% url 'home' %}"
          >EventMandu</a
        >
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav mx-auto text-center">
            <li class="nav-item">
              <a class="nav-link" href="{% url 'home' %}">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'events' %}">Events</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="{% url 'organizer_dashboard' %}"
                >Organizer</a
              >
            </li>
          </ul>
          <div class="d-flex align-items-center gap-2 justify-content-center">
            <button
              class="btn btn-sm theme-toggle"
              id="themeToggle"
              type="button"
              aria-label="Toggle theme"
            >
              <i class="fa-solid fa-moon"></i>
            </button>
            <a class="btn btn-sm btn-light" href="{% url 'logout' %}">Logout</a>
          </div>
        </div>
      </div>
    </nav>

    <main class="section-space pt-4 flex-grow-1">
      <div class="container">
        {% if messages %}
        <div class="mb-3">
          {% for message in messages %}
          <div class="alert alert-{{ message.tags|default:'info' }} mb-2">
            {{ message }}
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h1 class="section-title mb-1">Organizer Dashboard</h1>
            <p class="section-subtitle mb-0">
              Business-level control for your events.
            </p>
          </div>
          <a
            href="{% url 'organizer_event_create' %}"
            class="btn btn-primary-brand"
            ><i class="fa-solid fa-plus me-2"></i>Create New Event</a
          >
        </div>

        <section class="row g-3 mb-4">
          <div class="col-lg-3 col-md-6">
            <div class="event-card">
              <p class="event-meta mb-1">My Events Count</p>
              <h4 class="mb-0">{{ my_events_count }}</h4>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="event-card">
              <p class="event-meta mb-1">My Total Revenue</p>
              <h4 class="event-price mb-0">NPR {{ my_total_revenue }}</h4>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="event-card">
              <p class="event-meta mb-1">Total Tickets Sold</p>
              <h4 class="mb-0">{{ total_tickets_sold }}</h4>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="event-card">
              <p class="event-meta mb-1">Upcoming Events</p>
              <h4 class="mb-0">{{ upcoming_events_count }}</h4>
            </div>
          </div>
        </section>

        <section class="event-card mb-4">
          <h5 class="mb-3">Monthly Revenue</h5>
          <canvas id="monthlyRevenueChart" height="110"></canvas>
        </section>

        <section class="event-card mb-4">
          <h5 class="mb-3">Event Performance Analytics</h5>
          <form method="get" class="row g-2 mb-3">
            <div class="col-md-6">
              <input
                type="text"
                name="event_q"
                value="{{ event_q }}"
                class="form-control form-control-sm"
                placeholder="Search events by title, venue, city, category"
              />
            </div>
            <input type="hidden" name="attendee_q" value="{{ attendee_q }}" />
            <div class="col-md-2 d-grid">
              <button type="submit" class="btn btn-outline-brand btn-sm">
                Search
              </button>
            </div>
            <div class="col-md-2 d-grid">
              <a
                href="{% url 'organizer_dashboard' %}"
                class="btn btn-outline-secondary btn-sm rounded-pill dashboard-action-btn w-100"
                >Clear</a
              >
            </div>
          </form>
          <div class="table-responsive">
            <table class="table mb-0">
              <thead>
                <tr>
                  <th>Event</th>
                  <th>Date</th>
                  <th>Tickets Sold</th>
                  <th>Revenue</th>
                  <th>Approval</th>
                  <th>Manage</th>
                  <th>Bookings</th>
                </tr>
              </thead>
              <tbody>
                {% for event in events %}
                <tr>
                  <td>{{ event.title }}</td>
                  <td>{{ event.start_date|date:"M d, Y h:i A" }}</td>
                  <td>{{ event.sold_tickets }}</td>
                  <td>NPR {{ event.revenue }}</td>
                  <td>{{ event.approval_status|title }}</td>
                  <td>
                    <div class="d-flex gap-2">
                      <a
                        href="{% url 'organizer_event_edit' event.id %}"
                        class="btn btn-outline-brand btn-sm dashboard-action-btn dashboard-manage-btn"
                        >Edit</a
                      >
                      <form
                        method="post"
                        action="{% url 'organizer_event_delete' event.id %}"
                        onsubmit="return confirm('Delete this event?');"
                      >
                        {% csrf_token %}
                        <button
                          type="submit"
                          class="btn btn-outline-danger btn-sm rounded-pill dashboard-action-btn dashboard-manage-btn"
                        >
                          Delete
                        </button>
                      </form>
                    </div>
                  </td>
                  <td>
                    <a
                      href="{% url 'organizer_event_attendees_csv' event.id %}"
                      class="btn btn-accent-brand btn-sm"
                      >Download CSV</a
                    >
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="7" class="text-center">No events available.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if events.paginator.num_pages > 1 %}
          <nav class="mt-3" aria-label="Events pagination">
            <ul class="pagination pagination-sm mb-0">
              {% if events.has_previous %}
              <li class="page-item">
                <a
                  class="page-link"
                  href="?event_q={{ event_q|urlencode }}&attendee_q={{ attendee_q|urlencode }}&event_page={{ events.previous_page_number }}&attendee_page={{ attendees.number }}"
                  >Previous</a
                >
              </li>
              {% else %}
              <li class="page-item disabled">
                <span class="page-link">Previous</span>
              </li>
              {% endif %}
              <li class="page-item disabled">
                <span class="page-link"
                  >Page {{ events.number }} / {{ events.paginator.num_pages
                  }}</span
                >
              </li>
              {% if events.has_next %}
              <li class="page-item">
                <a
                  class="page-link"
                  href="?event_q={{ event_q|urlencode }}&attendee_q={{ attendee_q|urlencode }}&event_page={{ events.next_page_number }}&attendee_page={{ attendees.number }}"
                  >Next</a
                >
              </li>
              {% else %}
              <li class="page-item disabled">
                <span class="page-link">Next</span>
              </li>
              {% endif %}
            </ul>
          </nav>
          {% endif %}
        </section>

        <section class="event-card mb-4">
          <h5 class="mb-3">Booking Management (Attendees)</h5>
          <form method="get" class="row g-2 mb-3">
            <div class="col-md-6">
              <input
                type="text"
                name="attendee_q"
                value="{{ attendee_q }}"
                class="form-control form-control-sm"
                placeholder="Search attendees by username, email, event, order id"
              />
            </div>
            <input type="hidden" name="event_q" value="{{ event_q }}" />
            <div class="col-md-2 d-grid">
              <button type="submit" class="btn btn-outline-brand btn-sm">
                Search
              </button>
            </div>
            <div class="col-md-2 d-grid">
              <a
                href="{% url 'organizer_dashboard' %}"
                class="btn btn-outline-secondary btn-sm rounded-pill dashboard-action-btn w-100"
                >Clear</a
              >
            </div>
          </form>
          <div class="table-responsive">
            <table class="table mb-0">
              <thead>
                <tr>
                  <th>Attendee</th>
                  <th>Event</th>
                  <th>Qty</th>
                  <th>Amount</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                {% for purchase in attendees %}
                <tr>
                  <td>
                    {{ purchase.user.username }}<br /><small class="text-muted"
                      >{{ purchase.user.email }}</small
                    >
                  </td>
                  <td>{{ purchase.event.title }}</td>
                  <td>{{ purchase.quantity }}</td>
                  <td>NPR {{ purchase.total_amount }}</td>
                  <td>{{ purchase.created_at|date:"M d, Y h:i A" }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="5" class="text-center">
                    No attendee bookings yet.
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if attendees.paginator.num_pages > 1 %}
          <nav class="mt-3" aria-label="Attendees pagination">
            <ul class="pagination pagination-sm mb-0">
              {% if attendees.has_previous %}
              <li class="page-item">
                <a
                  class="page-link"
                  href="?event_q={{ event_q|urlencode }}&attendee_q={{ attendee_q|urlencode }}&event_page={{ events.number }}&attendee_page={{ attendees.previous_page_number }}"
                  >Previous</a
                >
              </li>
              {% else %}
              <li class="page-item disabled">
                <span class="page-link">Previous</span>
              </li>
              {% endif %}
              <li class="page-item disabled">
                <span class="page-link"
                  >Page {{ attendees.number }} / {{
                  attendees.paginator.num_pages }}</span
                >
              </li>
              {% if attendees.has_next %}
              <li class="page-item">
                <a
                  class="page-link"
                  href="?event_q={{ event_q|urlencode }}&attendee_q={{ attendee_q|urlencode }}&event_page={{ events.number }}&attendee_page={{ attendees.next_page_number }}"
                  >Next</a
                >
              </li>
              {% else %}
              <li class="page-item disabled">
                <span class="page-link">Next</span>
              </li>
              {% endif %}
            </ul>
          </nav>
          {% endif %}
        </section>
      </div>
    </main>

    <footer class="site-footer">
      <div class="container text-center">
        <small><i class="fa-regular fa-copyright"></i> 2026 EventMandu</small>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      (function () {
        const root = document.documentElement;
        const toggle = document.getElementById("themeToggle");
        const saved = localStorage.getItem("eventmandu-theme");
        if (saved) {
          root.setAttribute("data-bs-theme", saved);
        }
        if (toggle) {
          toggle.addEventListener("click", function () {
            const current = root.getAttribute("data-bs-theme") === "dark" ? "dark" : "light";
            const next = current === "dark" ? "light" : "dark";
            root.setAttribute("data-bs-theme", next);
            localStorage.setItem("eventmandu-theme", next);
          });
        }

        const labels = {{ monthly_labels_json|safe }};
        const revenue = {{ monthly_revenue_json|safe }};
        const canvas = document.getElementById("monthlyRevenueChart");
        if (canvas && labels.length) {
          const chartColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2f6fd0';
          new Chart(canvas, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Revenue (NPR)',
                data: revenue,
                borderColor: chartColor,
                backgroundColor: 'rgba(47, 111, 208, 0.16)',
                borderWidth: 2,
                fill: true,
                tension: 0.35
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { display: true } },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }
      })();
    </script>
  </body>
</html>
